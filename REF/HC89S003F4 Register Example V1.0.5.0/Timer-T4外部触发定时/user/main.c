/**
*   ************************************************************************************
*								上海芯圣电子股份有限公司
*								    www.holychip.cn
*	************************************************************************************
*	@Examle Version		V1.0.5.0
*	@Demo 	Version		V1.0.4.0
*	@Date				2019.12.27
*	************************************************************************************
*									 模块性能介绍
* 1、定时器4有三种工作模式
*	   工作模式1：16位自动重载定时器
*	   工作模式2；串口波特率发生器
*	   工作模式3：有T4边沿触发的16位自动重载定时器
*	************************************************************************************
*									 应用注意事项
*	1、T4外部时钟必须输入一个方波
*	2、T4外部时钟输入口必须设置为数字输入
*	3、不可以在中断中判断中断标志位
*	************************************************************************************
*  								       客户服务
*	感谢您使用我们的单片机，若发现错误或对函数的使用存在疑问。请添加上海芯圣电子官方QQ群
*	****************************技术支持群：201030494***********************************
*   ************************************************************************************
**/

#define ALLOCATE_EXTERN
#include "HC89S003F4.h"

/***************************************************************************************
  * @实现效果	T4设置为外部触发模式，P11检测到一个下降沿，定时1s后进入中断，P00翻转
***************************************************************************************/
void main()
{
/************************************系统初始化****************************************/
	WDTCCR = 0x00;						//关闭看门狗
		                        //本例程为方便测试关闭看门狗，实际使用中，建议客户打开看门狗，详见WDT复位例程
	CLKSWR = 0x51;						//选择内部高频RC为系统时钟，内部高频RC 2分频，Fosc=16MHz
	CLKDIV = 0x01;						//Fosc 1分频得到Fcpu，Fcpu=16MHz 
/**********************************相关配置初始化**************************************/
	P0M0 = P0M0&0xF0|0x08;		//P00设置为推挽输出
/**********************************TIM4配置初始化**************************************/
  P1M0 = P1M0&0x0F|0x20;    //P11设置为上拉输入    
	T4_MAP = 0x11;	 					//外部触发端口映射P11

	//Tim4计算时间 	= (65536 - 0x0BDC) * (1 / (Fosc /Timer分频系数))
	//				= 62500 / (16000000 / 256)
	//				= 1s

	//定时1s
	//反推初值 	= 65536 - (1 / (1/(Fosc / Timer分频系数)))
	//		   	= 65536 - (1 / (1/(16000000 / 256)))
	//			= 65536 - 62500
	//			= 0x0BDC

	TH4 = 0x0B;
	TL4 = 0xDC; 						 //定时1s
	T4CON = 0x7E;						 //允许下降沿触发，时钟256分频
	IE1 |= 0x04;						 //打开T4中断

	EA = 1;								   //开总中断
	while(1);
}

/***************************************************************************************
  * @说明  	T4中断服务函数
  *	@参数 	无
  * @返回值 无
  * @注	  	无
***************************************************************************************/
void TIMER4_Rpt(void) interrupt T4_VECTOR
{
	T4CON &=~ 0x80;						//清除中断标志位
	P0_0 =~ P0_0;						  //P00翻转
}